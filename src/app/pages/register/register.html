<mat-toolbar>
    <a mat-icon-button
       routerLink="/">
        <mat-icon>arrow_back</mat-icon>
    </a>
    <span>Registro</span>
</mat-toolbar>

<form class="register-form"
      [formGroup]="form"
      (ngSubmit)="submit()"
      novalidate>
    <h1>Crear cuenta</h1>
    <p class="subtitle">Únete a VOID y comienza tu viaje por la galaxia.</p>

    <mat-form-field appearance="outline"
                    class="full">
        <mat-label>Email</mat-label>
        <input matInput
               type="email"
               formControlName="email"
               autocomplete="email"
               required />
        <mat-icon matSuffix>mail</mat-icon>
        @if (email()?.hasError('required')) {
        <mat-error>El email es obligatorio.</mat-error> } @if
        (email()?.hasError('email')) {
        <mat-error>Introduce un email válido.</mat-error> } @if
        (email()?.hasError('emailTaken')) {
        <mat-error>Este email ya está en uso.</mat-error> }
    </mat-form-field>

    <mat-form-field appearance="outline"
                    class="full">
        <mat-label>Apodo</mat-label>
        <input matInput
               formControlName="nickname"
               autocomplete="nickname"
               required />
        <mat-icon matSuffix>person</mat-icon>
        <mat-hint>3–50 caracteres</mat-hint>
        @if (nickname()?.hasError('required')) {
        <mat-error>El apodo es obligatorio.</mat-error> } @if
        (nickname()?.hasError('minlength')){
        <mat-error>Mínimo 3 caracteres.</mat-error> } @if
        (nickname()?.hasError('maxlength')){
        <mat-error>Máximo 50 caracteres.</mat-error> }
    </mat-form-field>

    <div formGroupName="passwordGroup"
         class="full">
        <mat-form-field appearance="outline"
                        class="full">
            <mat-label>Contraseña</mat-label>
            <input matInput
                   [type]="hidePassword() ? 'password' : 'text'"
                   formControlName="password"
                   autocomplete="new-password"
                   required />
            <button type="button"
                    mat-icon-button
                    matSuffix
                    (click)="toggleHidePassword()"
                    aria-label="Mostrar/Ocultar contraseña">
                <mat-icon>{{
              hidePassword() ? 'visibility' : 'visibility_off'
            }}</mat-icon>
            </button>
            <mat-hint>Mínimo 8 caracteres, combinación segura.</mat-hint>
            @if (password()?.hasError('required')) {
            <mat-error>La contraseña es obligatoria.</mat-error> } @if
            (password()?.hasError('minlength')) {
            <mat-error>Al menos 8 caracteres.</mat-error> } @if
            (password()?.hasError('complexity')){
            <mat-error>Usa 3 de 4: mayúscula, minúscula, número, símbolo.</mat-error>
            }
        </mat-form-field>

        <div class="strength"
             [attr.data-level]="passwordStrength()">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            <small>Seguridad: {{ passwordStrength() }}</small>
        </div>

        <mat-form-field appearance="outline"
                        class="full">
            <mat-label>Confirmar contraseña</mat-label>
            <input matInput
                   [type]="hideConfirm() ? 'password' : 'text'"
                   formControlName="confirm"
                   autocomplete="new-password"
                   required />
            <button type="button"
                    mat-icon-button
                    matSuffix
                    (click)="toggleHideConfirm()"
                    aria-label="Mostrar/Ocultar confirmación">
                <mat-icon>{{
              hideConfirm() ? 'visibility' : 'visibility_off'
            }}</mat-icon>
            </button>
            @if (confirm()?.hasError('required')) {
            <mat-error>Confirma tu contraseña.</mat-error> } @if
            (passwordGroup()?.hasError('passwordMismatch')) {
            <mat-error>Las contraseñas no coinciden.</mat-error> }
        </mat-form-field>
    </div>

    <mat-checkbox formControlName="acceptTerms"
                  class="terms">
        Acepto los
        <a href="/legal/terms"
           target="_blank"
           rel="noopener">términos y condiciones</a>.
    </mat-checkbox>
    @if (acceptTerms()?.invalid && acceptTerms()?.touched) {
    <div class="terms-error"
         role="alert">Debes aceptar los términos.</div>
    }

    <div class="actions">
        <button mat-flat-button
                color="primary"
                type="submit"
                [disabled]="form.invalid || submitting()">
            {{ submitting() ? 'Creando cuenta…' : 'Crear cuenta' }}
        </button>
        <a mat-button
           routerLink="/auth/login">¿Ya tienes cuenta? Inicia sesión</a>
    </div>

    @if (serverError()) {
    <div class="server-error"
         role="alert">{{ serverError() }}</div>
    }
</form>